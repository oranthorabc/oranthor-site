<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Presale ORR Dashboard (Testnet)</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.5/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bignumber.js@9.1.2/bignumber.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script> <!-- WalletConnect -->
  <style>
    body {
      background: linear-gradient(135deg, #0a1d37, #1a2f4c);
      font-family: 'Poppins', sans-serif;
      color: #e0e7ff;
      text-align: center;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .container {
      background: rgba(10, 29, 55, 0.95);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      width: 100%;
      max-width: 700px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .header {
      margin-bottom: 25px;
      color: #ffffff;
      font-size: 28px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .status {
      font-size: 15px;
      margin: 12px 0;
      color: #b0c4de;
    }
    .input-group {
      margin: 20px 0;
    }
    input {
      background: #1a3c6e;
      color: #e0e7ff;
      border: none;
      padding: 14px;
      border-radius: 10px;
      width: 280px;
      text-align: center;
      font-size: 16px;
      transition: box-shadow 0.3s, transform 0.2s;
    }
    input:focus {
      outline: none;
      box-shadow: 0 0 8px #4dabf7;
      transform: scale(1.02);
    }
    .balance, .info {
      margin: 12px 0;
      font-size: 16px;
      line-height: 1.5;
    }
    button {
      margin: 10px 5px;
      padding: 12px 25px;
      border-radius: 10px;
      font-size: 16px;
      border: none;
      cursor: pointer;
      transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    .btn-buy {
      background-color: #4dabf7;
      color: #fff;
    }
    .btn-buy:hover:not(:disabled) {
      background-color: #339af0;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(77, 171, 247, 0.5);
    }
    .btn-claim {
      background-color: #2ecc71;
      color: #fff;
    }
    .btn-claim:hover:not(:disabled) {
      background-color: #27ae60;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.5);
    }
    .btn-info {
      background-color: #f39c12;
      color: #fff;
    }
    .btn-info:hover:not(:disabled) {
      background-color: #e67e22;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(243, 156, 18, 0.5);
    }
    .error {
      color: #ff6b6b;
      font-size: 14px;
      margin-top: 10px;
      animation: blink 1s infinite;
    }
    .note {
      font-size: 12px;
      color: #a3bffa;
      margin-top: 20px;
    }
    .testnet-note {
      font-size: 12px;
      color: #7b8ed4;
      margin-top: 10px;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4dabf7;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }
    #countdown {
      font-weight: 600;
      color: #2ecc71;
      animation: pulse 2s infinite;
    }
    #roundInfo {
      color: #1abc9c;
      font-weight: bold;
    }
    @keyframes blink {
      50% { opacity: 0.5; }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 600px) {
      .container {
        padding: 15px;
        max-width: 90%;
      }
      input {
        width: 220px;
      }
      button {
        padding: 10px 20px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">Presale ORR Dashboard (Testnet)</div>
  <div class="status" id="walletStatus">Chưa kết nối ví</div>
  <div class="status" id="networkStatus"></div>
  <div class="input-group">
    <label for="orrAmount">Số lượng ORR muốn mua: <span id="desiredOrrAmount">-</span></label><br>
    <input type="number" id="orrAmount" placeholder="Nhập số ORR" min="0" step="1">
  </div>
  <div class="info">USDT cần trả: <span id="usdtRequired">-</span></div>
  <div class="info">Vòng hiện tại: <span id="roundInfo">-</span></div>
  <div class="info">Giá ORR hiện tại: <span id="currentPrice">-</span></div>
  <div class="info">Số dư USDT của bạn: <span id="userUsdtBalance">-</span></div>
  <div class="info">ORR đã bán vòng hiện tại: <span id="soldPerRound">-</span></div>
  <div class="info">Tổng ORR đã bán: <span id="totalSold">-</span></div>
  <div class="info">Trạng thái presale: <span id="idoStatus">-</span></div>
  <div class="info">Thời gian còn lại: <span id="countdown">-</span></div>
  <div class="info">Tổng đã mua: <span id="totalPurchased">-</span></div>
  <div class="info">Đã claim: <span id="claimed">-</span></div>
  <div class="info">Số ORR có thể claim: <span id="claimable">-</span></div>
  <button class="btn-buy" id="buyButton" onclick="approveAndBuy()" disabled>Mua ORR</button>
  <button class="btn-claim" id="claimButton" onclick="claimORR()" disabled>Claim ORR</button>
  <button class="btn-info" id="infoButton" onclick="showMyPurchase()" disabled>Chi tiết mua</button>
  <div id="purchaseInfo"></div>
  <div id="errorMessage" class="error"></div>
  <div class="loader" id="loader"></div>
  <p class="note">Miễn trừ trách nhiệm: Token ORR không đại diện cho cổ phần, thu nhập hay lợi nhuận. Đây không phải là lời mời đầu tư.</p>
  <p class="testnet-note">Đây là môi trường testnet. Sử dụng faucet để nhận testnet ETH/USDT nếu cần.</p>
</div>

<script>
const presaleAddress = "0x2254B2A71851199463A058b28D7EeFd4C0723aEF";
const usdtAddress = "0x7D14D82D8F60B7De6535bCa423862a4900D21F07";
const orrAddress = "0x9772994F416CCE690c53D25997D4383294b01DBB";
const expectedChainId = "97";
const testnetNames = {
  "97": "BSC Testnet",
  "11155111": "Sepolia",
  "80001": "Polygon Mumbai",
  "43113": "Avalanche Fuji"
};

const presaleABI = [
  {
    "inputs": [
      {"internalType": "address", "name": "_orr", "type": "address"},
      {"internalType": "address", "name": "_usdt", "type": "address"}
    ],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "anonymous": false,
    "inputs": [
      {"indexed": true, "internalType": "address", "name": "buyer", "type": "address"},
      {"indexed": false, "internalType": "uint256", "name": "usdtAmount", "type": "uint256"},
      {"indexed": false, "internalType": "uint256", "name": "orrAmount", "type": "uint256"}
    ],
    "name": "Bought",
    "type": "event"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "usdtAmount", "type": "uint256"}
    ],
    "name": "buy",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "claim",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "anonymous": false,
    "inputs": [
      {"indexed": true, "internalType": "address", "name": "user", "type": "address"},
      {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"}
    ],
    "name": "Claimed",
    "type": "event"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "amount", "type": "uint256"}
    ],
    "name": "injectORR",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "anonymous": false,
    "inputs": [
      {"indexed": true, "internalType": "address", "name": "previousOwner", "type": "address"},
      {"indexed": true, "internalType": "address", "name": "newOwner", "type": "address"}
    ],
    "name": "OwnershipTransferred",
    "type": "event"
  },
  {
    "inputs": [],
    "name": "renounceOwnership",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "anonymous": false,
    "inputs": [
      {"indexed": false, "internalType": "uint8", "name": "newRound", "type": "uint8"}
    ],
    "name": "RoundChanged",
    "type": "event"
  },
  {
    "inputs": [],
    "name": "setIdoCompleted",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint8", "name": "round", "type": "uint8"},
      {"internalType": "uint256", "name": "price", "type": "uint256"}
    ],
    "name": "setRoundPrice",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "address", "name": "newOwner", "type": "address"}
    ],
    "name": "transferOwnership",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "anonymous": false,
    "inputs": [
      {"indexed": true, "internalType": "address", "name": "owner", "type": "address"},
      {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"}
    ],
    "name": "USDTReceived",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {"indexed": true, "internalType": "address", "name": "to", "type": "address"},
      {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"}
    ],
    "name": "Withdrawn",
    "type": "event"
  },
  {
    "inputs": [
      {"internalType": "address", "name": "to", "type": "address"}
    ],
    "name": "withdrawUSDT",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "address", "name": "", "type": "address"}
    ],
    "name": "buyers",
    "outputs": [
      {"internalType": "uint256", "name": "totalPurchased", "type": "uint256"},
      {"internalType": "uint256", "name": "claimed", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "address", "name": "user", "type": "address"}
    ],
    "name": "claimable",
    "outputs": [
      {"internalType": "uint256", "name": "", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "currentRound",
    "outputs": [
      {"internalType": "uint8", "name": "", "type": "uint8"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "address", "name": "user", "type": "address"}
    ],
    "name": "getBuyerInfo",
    "outputs": [
      {"internalType": "uint256", "name": "totalPurchased", "type": "uint256"},
      {"internalType": "uint256", "name": "claimed", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint8", "name": "round", "type": "uint8"}
    ],
    "name": "getRoundStartTime",
    "outputs": [
      {"internalType": "uint256", "name": "", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint8", "name": "round", "type": "uint8"}
    ],
    "name": "getSoldPerRound",
    "outputs": [
      {"internalType": "uint256", "name": "", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "idoCompleted",
    "outputs": [
      {"internalType": "bool", "name": "", "type": "bool"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "idoStartTime",
    "outputs": [
      {"internalType": "uint256", "name": "", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "MAX_ROUND_DURATION",
    "outputs": [
      {"internalType": "uint256", "name": "", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "MAX_SALE",
    "outputs": [
      {"internalType": "uint256", "name": "", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "ORR",
    "outputs": [
      {"internalType": "contract IERC20", "name": "", "type": "address"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "owner",
    "outputs": [
      {"internalType": "address", "name": "", "type": "address"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "ROUND_SIZE",
    "outputs": [
      {"internalType": "uint256", "name": "", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint8", "name": "", "type": "uint8"}
    ],
    "name": "roundPrices",
    "outputs": [
      {"internalType": "uint256", "name": "", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint8", "name": "", "type": "uint8"}
    ],
    "name": "roundStartTime",
    "outputs": [
      {"internalType": "uint256", "name": "", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint8", "name": "", "type": "uint8"}
    ],
    "name": "soldPerRound",
    "outputs": [
      {"internalType": "uint256", "name": "", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "totalSold",
    "outputs": [
      {"internalType": "uint256", "name": "", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "USDT",
    "outputs": [
      {"internalType": "contract IERC20", "name": "", "type": "address"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "usdtDecimals",
    "outputs": [
      {"internalType": "uint256", "name": "", "type": "uint256"}
    ],
    "stateMutability": "view",
    "type": "function"
  }
];

const usdtABI = [
  {
    "constant": true,
    "inputs": [],
    "name": "name",
    "outputs": [{"name": "", "type": "string"}],
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "symbol",
    "outputs": [{"name": "", "type": "string"}],
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "decimals",
    "outputs": [{"name": "", "type": "uint8"}],
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [{"name": "_owner", "type": "address"}],
    "name": "balanceOf",
    "outputs": [{"name": "balance", "type": "uint256"}],
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [
      {"name": "_owner", "type": "address"},
      {"name": "_spender", "type": "address"}
    ],
    "name": "allowance",
    "outputs": [{"name": "", "type": "uint256"}],
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [
      {"name": "_spender", "type": "address"},
      {"name": "_value", "type": "uint256"}
    ],
    "name": "approve",
    "outputs": [{"name": "", "type": "bool"}],
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [
      {"name": "_to", "type": "address"},
      {"name": "_value", "type": "uint256"}
    ],
    "name": "transfer",
    "outputs": [{"name": "", "type": "bool"}],
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [
      {"name": "_from", "type": "address"},
      {"name": "_to", "type": "address"},
      {"name": "_value", "type": "uint256"}
    ],
    "name": "transferFrom",
    "outputs": [{"name": "", "type": "bool"}],
    "type": "function"
  },
  {
    "anonymous": false,
    "inputs": [
      {"indexed": true, "name": "from", "type": "address"},
      {"indexed": true, "name": "to", "type": "address"},
      {"indexed": false, "name": "value", "type": "uint256"}
    ],
    "name": "Transfer",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {"indexed": true, "name": "owner", "type": "address"},
      {"indexed": true, "name": "spender", "type": "address"},
      {"indexed": false, "name": "value", "type": "uint256"}
    ],
    "name": "Approval",
    "type": "event"
  }
];

const orrABI = [
  {
    "constant": true,
    "inputs": [
      {"name": "_owner", "type": "address"}
    ],
    "name": "balanceOf",
    "outputs": [{"name": "balance", "type": "uint256"}],
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "decimals",
    "outputs": [{"name": "", "type": "uint8"}],
    "type": "function"
  }
];

let web3;
let account;
let presale;
let usdt;
let orr;
let walletConnectProvider;

let presaleCache = null;
const CACHE_DURATION = 10000; // 10 giây

function showError(message) {
  const errorDiv = document.getElementById("errorMessage");
  if (!errorDiv) {
    console.error("📛 Không tìm thấy phần tử errorMessage trong DOM");
    return;
  }
  errorDiv.innerText = message;
  errorDiv.style.display = "block";
  setTimeout(() => (errorDiv.style.display = "none"), 5000);
}

function toggleButtons(disabled) {
  document.getElementById("buyButton").disabled = disabled;
  document.getElementById("claimButton").disabled = disabled;
  document.getElementById("infoButton").disabled = disabled;
}

async function checkNetwork() {
  try {
    const chainId = await web3.eth.getChainId();
    const networkName = testnetNames[chainId] || `Unknown (Chain ID: ${chainId})`;
    if (chainId.toString() !== expectedChainId) {
      showError(`Vui lòng chuyển sang ${testnetNames[expectedChainId] || "mạng testnet phù hợp"} (Chain ID: ${expectedChainId})`);
      document.getElementById("networkStatus").innerText = `Mạng không đúng: ${networkName}`;
      toggleButtons(true);
      return false;
    }
    document.getElementById("networkStatus").innerText = `Mạng: ${networkName}`;
    return true;
  } catch (err) {
    showError("Không thể kiểm tra mạng: " + err.message);
    return false;
  }
}

async function initWeb3() {
  if (window.ethereum) {
    // Ưu tiên MetaMask
    web3 = new Web3(window.ethereum);
    try {
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      const accounts = await web3.eth.getAccounts();
      if (!accounts.length) throw new Error("Không tìm thấy tài khoản");
      account = accounts[0];
      document.getElementById("walletStatus").innerText = `Đã kết nối: ${account.slice(0, 6)}...${account.slice(-4)}`;

      presale = new web3.eth.Contract(presaleABI, presaleAddress);
      usdt = new web3.eth.Contract(usdtABI, usdtAddress);
      orr = new web3.eth.Contract(orrABI, orrAddress);

      if (await checkNetwork()) {
        toggleButtons(false);
        updatePresaleInfo(true);
      }

      window.ethereum.on('accountsChanged', async (accounts) => {
        if (!accounts.length) {
          document.getElementById("walletStatus").innerText = "Chưa kết nối ví";
          toggleButtons(true);
        } else {
          account = accounts[0];
          document.getElementById("walletStatus").innerText = `Đã kết nối: ${account.slice(0, 6)}...${account.slice(-4)}`;
          if (await checkNetwork()) {
            toggleButtons(false);
            updatePresaleInfo(true);
          }
        }
      });

      window.ethereum.on('chainChanged', async () => {
        if (await checkNetwork()) {
          toggleButtons(false);
          updatePresaleInfo(true);
        } else {
          toggleButtons(true);
        }
      });
    } catch (err) {
      showError("Không thể kết nối ví MetaMask: " + err.message);
      // Fallback to WalletConnect
      initWalletConnect();
    }
  } else {
    showError("Vui lòng cài đặt MetaMask hoặc sử dụng WalletConnect!");
    initWalletConnect();
  }
}

function initWalletConnect() {
  if (typeof window.WalletConnectProvider !== 'undefined') {
    walletConnectProvider = new WalletConnectProvider({
      infuraId: "YOUR_INFURA_ID", // Thay bằng Infura ID của bạn
      rpc: {
        97: "https://data-seed-prebsc-1-s1.binance.org:8545/" // RPC cho BSC Testnet
      },
      chainId: 97,
      qrcode: true // Hiển thị QR code trên mobile
    });

    walletConnectProvider.on("connect", () => {
      web3 = new Web3(walletConnectProvider);
      web3.eth.getAccounts().then(accounts => {
        account = accounts[0];
        document.getElementById("walletStatus").innerText = `Đã kết nối WC: ${account.slice(0, 6)}...${account.slice(-4)}`;
        presale = new web3.eth.Contract(presaleABI, presaleAddress);
        usdt = new web3.eth.Contract(usdtABI, usdtAddress);
        orr = new web3.eth.Contract(orrABI, orrAddress);
        checkNetwork().then(isCorrect => {
          if (isCorrect) {
            toggleButtons(false);
            updatePresaleInfo(true);
          }
        });
      });
    });

    walletConnectProvider.on("disconnect", () => {
      document.getElementById("walletStatus").innerText = "Chưa kết nối ví";
      toggleButtons(true);
      presaleCache = null;
    });

    walletConnectProvider.enable().catch(err => {
      showError("Không thể kết nối WalletConnect: " + err.message);
    });
  } else {
    showError("Không thể khởi tạo WalletConnect. Vui lòng kiểm tra kết nối internet.");
  }
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function formatTime(seconds) {
  if (seconds <= 0) return "0d:0h:0m:0s";
  const days = Math.floor(seconds / (24 * 3600));
  seconds %= (24 * 3600);
  const hours = Math.floor(seconds / 3600);
  seconds %= 3600;
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${days}d:${hours}h:${minutes}m:${secs}s`;
}

async function updatePresaleInfo(force = false) {
  document.getElementById("loader").style.display = "block";
  try {
    if (!force && presaleCache && Date.now() - presaleCache.timestamp < CACHE_DURATION) {
      updateUI(presaleCache.data);
      return;
    }

    const round = await presale.methods.currentRound().call().catch(() => "1");
    const price = await presale.methods.roundPrices(round).call().catch(() => "0");
    const idoCompleted = await presale.methods.idoCompleted().call().catch(() => false);
    const totalSold = await presale.methods.totalSold().call().catch(() => "0");
    const idoStartTime = await presale.methods.idoStartTime().call().catch(() => "0");
    const roundStartTime = await presale.methods.getRoundStartTime(round).call().catch(() => "0");
    const soldPerRound = await presale.methods.getSoldPerRound(round).call().catch(() => "0");
    const buyerInfo = await presale.methods.getBuyerInfo(account).call().catch(() => ["0", "0"]);
    const claimableAmount = await presale.methods.claimable(account).call().catch(() => "0");
    const usdtDecimals = await usdt.methods.decimals().call().catch(() => "6");
    const orrDecimals = await orr.methods.decimals().call().catch(() => "18");
    const usdtName = await usdt.methods.name().call().catch(() => "USDT");
    const usdtSymbol = await usdt.methods.symbol().call().catch(() => "USDT");
    const userUsdtBalance = await usdt.methods.balanceOf(account).call().catch(() => "0");

    const cacheData = {
      round,
      price,
      idoCompleted,
      totalSold,
      idoStartTime,
      roundStartTime,
      soldPerRound,
      buyerInfo: { totalPurchased: buyerInfo[0], claimed: buyerInfo[1] },
      claimableAmount,
      usdtDecimals,
      orrDecimals,
      usdtName,
      usdtSymbol,
      userUsdtBalance
    };
    presaleCache = { data: cacheData, timestamp: Date.now() };

    function updateUI(data) {
      document.getElementById("roundInfo").innerText = `Vòng ${data.round || 'Chưa khởi tạo'}`;
      document.getElementById("currentPrice").innerText = data.price ? new BigNumber(data.price).div(Math.pow(10, data.orrDecimals)).toFixed(6) + " " + data.usdtSymbol : "Chưa thiết lập giá";
      document.getElementById("idoStatus").innerText = data.idoCompleted ? "Đã kết thúc" : "Chưa kết thúc";
      document.getElementById("totalSold").innerText = new BigNumber(data.totalSold).div(Math.pow(10, data.orrDecimals)).toFixed(2) + " ORR";
      document.getElementById("soldPerRound").innerText = new BigNumber(data.soldPerRound).div(Math.pow(10, data.orrDecimals)).toFixed(2) + " ORR";
      document.getElementById("totalPurchased").innerText = new BigNumber(data.buyerInfo.totalPurchased).div(Math.pow(10, data.orrDecimals)).toFixed(2) + " ORR";
      document.getElementById("claimed").innerText = new BigNumber(data.buyerInfo.claimed).div(Math.pow(10, data.orrDecimals)).toFixed(2) + " ORR";
      document.getElementById("claimable").innerText = new BigNumber(data.claimableAmount).div(Math.pow(10, data.orrDecimals)).toFixed(2) + " ORR";
      document.getElementById("userUsdtBalance").innerText = new BigNumber(data.userUsdtBalance).div(Math.pow(10, data.usdtDecimals)).toFixed(2) + " " + data.usdtSymbol;

      const updateUsdtRequired = debounce(async () => {
        const value = Number(document.getElementById("orrAmount").value);
        if (value <= 0 || isNaN(value) || !data.price || new BigNumber(data.price).eq(0)) {
          document.getElementById("desiredOrrAmount").innerText = "-";
          document.getElementById("usdtRequired").innerText = "-";
          document.getElementById("buyButton").disabled = true;
        } else {
          document.getElementById("desiredOrrAmount").innerText = value.toString();
          const required = new BigNumber(value).multipliedBy(new BigNumber(data.price).div(Math.pow(10, data.orrDecimals))).toFixed(6);
          document.getElementById("usdtRequired").innerText = required + " " + data.usdtSymbol;
          document.getElementById("buyButton").disabled = new BigNumber(data.userUsdtBalance).lt(new BigNumber(required).multipliedBy(Math.pow(10, data.usdtDecimals)));
        }
      }, 300);

      document.getElementById("orrAmount").addEventListener("input", updateUsdtRequired);
      updateUsdtRequired();

      function updateCountdown() {
        const now = Math.floor(Date.now() / 1000); // 04:30 PM +07, June 17, 2025
        const maxDuration = 60 * 24 * 3600; // 60 days
        const startTime = Number(data.idoStartTime);
        if (isNaN(startTime) || startTime === 0) {
          document.getElementById("countdown").innerText = "Chưa bắt đầu presale";
          document.getElementById("buyButton").disabled = true;
        } else {
          const elapsed = now - startTime;
          const remaining = maxDuration - (elapsed > 0 ? elapsed : 0);
          if (remaining <= 0 || data.idoCompleted) {
            document.getElementById("countdown").innerText = "Vòng đã kết thúc";
            document.getElementById("buyButton").disabled = true;
          } else {
            document.getElementById("countdown").innerText = formatTime(remaining);
          }
        }
      }

      updateCountdown();
      setInterval(updateCountdown, 1000);
    }

    updateUI(cacheData);
  } catch (err) {
    showError("Lỗi khi tải thông tin presale: " + err.message);
  } finally {
    document.getElementById("loader").style.display = "none";
  }
}

async function approveAndBuy() {
  const amount = Number(document.getElementById("orrAmount").value);
  const buyBtn = document.getElementById("buyButton");

  if (amount <= 0 || isNaN(amount)) {
    showError("Vui lòng nhập số lượng ORR hợp lệ!");
    return;
  }

  buyBtn.disabled = true;
  buyBtn.innerText = "Đang xử lý...";

  try {
    const orrDecimals = await orr.methods.decimals().call();
    const usdtDecimals = await usdt.methods.decimals().call();
    const round = await presale.methods.currentRound().call();
    const price = await presale.methods.roundPrices(round).call();
    const idoCompleted = await presale.methods.idoCompleted().call();
    const totalSold = await presale.methods.totalSold().call();

    if (idoCompleted || round > 3) {
      showError("Presale đã kết thúc hoặc hết vòng!");
      resetBuyButton();
      return;
    }

    const orrAmount = new BigNumber(amount).multipliedBy(Math.pow(10, orrDecimals)).integerValue();
    const usdtAmount = new BigNumber(amount)
      .multipliedBy(new BigNumber(price).div(Math.pow(10, orrDecimals)))
      .multipliedBy(Math.pow(10, usdtDecimals))
      .integerValue();

    const maxSale = new BigNumber(180_000_000).multipliedBy(Math.pow(10, orrDecimals));
    if (new BigNumber(totalSold).plus(orrAmount).gt(maxSale)) {
      showError("Đã vượt giới hạn presale!");
      resetBuyButton();
      return;
    }

    const balance = await usdt.methods.balanceOf(account).call();
    if (new BigNumber(balance).lt(usdtAmount)) {
      showError("Số dư USDT không đủ! Sử dụng faucet testnet.");
      resetBuyButton();
      return;
    }

    const allowance = await usdt.methods.allowance(account, presaleAddress).call();
    if (new BigNumber(allowance).lt(usdtAmount)) {
      const gasApprove = await usdt.methods.approve(presaleAddress, usdtAmount.toString()).estimateGas({ from: account });

      await new Promise((resolve, reject) => {
        usdt.methods.approve(presaleAddress, usdtAmount.toString())
          .send({ from: account, gas: gasApprove })
          .on("transactionHash", (hash) => {
            console.log("📤 Approve gửi:", hash);
            buyBtn.innerText = "✅ Đã approve, đang mua...";
          })
          .on("receipt", (receipt) => {
            console.log("✅ Approve thành công:", receipt.transactionHash);
            resolve();
          })
          .on("error", (err) => {
            console.error("❌ Lỗi approve:", err);
            showError("❌ Giao dịch approve thất bại.\nChi tiết: " + err.message);
            resetBuyButton();
            reject(new Error("STOP"));
          });
      });
    }

    const gasBuy = await presale.methods.buy(usdtAmount.toString()).estimateGas({ from: account });

    await new Promise((resolve, reject) => {
      presale.methods.buy(usdtAmount.toString())
        .send({ from: account, gas: gasBuy })
        .on("transactionHash", (hash) => {
          console.log("📤 Gửi giao dịch mua:", hash);
          buyBtn.innerText = "⏳ Đang chờ xác nhận...";
        })
        .on("receipt", (receipt) => {
          console.log("✅ Mua thành công:", receipt.transactionHash);
          showError("🎉 Mua ORR thành công!");
          document.getElementById("orrAmount").value = "";
          document.getElementById("usdtRequired").innerText = "-";
          updatePresaleInfo(true).then(() => {
            resetBuyButton();
          });
          showMyPurchase();
          resolve();
        })
        .on("error", (err) => {
          console.error("❌ Lỗi khi mua:", err);
          showError("❌ Giao dịch bị từ chối hoặc lỗi kết nối.\nChi tiết: " + err.message);
          resetBuyButton();
          reject(new Error("Lỗi giao dịch"));
        });
    });
  } catch (err) {
    if (err.message === "STOP") return;
    console.error("❌ Lỗi tổng thể:", err);
    showError("Mua thất bại: " + err.message);
    resetBuyButton();
  }
}

function resetBuyButton() {
  const btn = document.getElementById("buyButton");
  btn.disabled = false;
  btn.innerText = "Mua ORR";
  const updateUsdtRequired = debounce(async () => {
    const value = Number(document.getElementById("orrAmount").value);
    if (presaleCache && presaleCache.data) {
      const data = presaleCache.data;
      if (value <= 0 || isNaN(value) || !data.price || new BigNumber(data.price).eq(0)) {
        document.getElementById("desiredOrrAmount").innerText = "-";
        document.getElementById("usdtRequired").innerText = "-";
        btn.disabled = true;
      } else {
        document.getElementById("desiredOrrAmount").innerText = value.toString();
        const required = new BigNumber(value).multipliedBy(new BigNumber(data.price).div(Math.pow(10, data.orrDecimals))).toFixed(6);
        document.getElementById("usdtRequired").innerText = required + " " + data.usdtSymbol;
        btn.disabled = new BigNumber(data.userUsdtBalance).lt(new BigNumber(required).multipliedBy(Math.pow(10, data.usdtDecimals)));
      }
    }
  }, 300);
  updateUsdtRequired();
}

async function claimORR() {
  const claimButton = document.getElementById("claimButton");
  claimButton.disabled = true;
  claimButton.innerText = "Đang xử lý...";

  try {
    const idoCompleted = await presale.methods.idoCompleted().call();
    if (!idoCompleted) {
      showError("Presale chưa kết thúc, chưa thể claim!");
      throw new Error("Presale chưa kết thúc");
    }

    const claimableAmount = await presale.methods.claimable(account).call();
    if (new BigNumber(claimableAmount).lte(0)) {
      showError("Không có ORR nào để claim!");
      throw new Error("Không có ORR nào để claim");
    }

    const gasClaim = await presale.methods.claim().estimateGas({ from: account });

    await new Promise((resolve, reject) => {
      presale.methods.claim()
        .send({ from: account, gas: gasClaim })
        .on("transactionHash", (hash) => {
          console.log("📤 Claim gửi:", hash);
          claimButton.innerText = "⏳ Đang chờ xác nhận...";
        })
        .on("receipt", (receipt) => {
          console.log("✅ Claim thành công:", receipt.transactionHash);
          showError("🎉 Claim ORR thành công!");
          resolve();
        })
        .on("error", (err) => {
          console.error("❌ Lỗi claim:", err);
          showError("❌ Claim thất bại.\nChi tiết: " + err.message);
          reject(err);
        });
    });

    showMyPurchase();
    updatePresaleInfo(true);
  } catch (err) {
    console.error("Lỗi claim:", err);
    showError("Claim thất bại: " + err.message);
  } finally {
    claimButton.disabled = false;
    claimButton.innerText = "Claim ORR";
  }
}

async function showMyPurchase() {
  try {
    const buyerInfo = await presale.methods.getBuyerInfo(account).call().catch(() => ["0", "0"]);
    const claimableAmount = await presale.methods.claimable(account).call().catch(() => "0");
    const orrDecimals = await orr.methods.decimals().call().catch(() => "18");

    const totalPurchased = buyerInfo[0] || "0";
    const claimed = buyerInfo[1] || "0";

    document.getElementById("purchaseInfo").innerText = 
      `Tổng đã mua: ${new BigNumber(totalPurchased).div(Math.pow(10, orrDecimals)).toFixed(2)} ORR\n` +
      `Đã claim: ${new BigNumber(claimed).div(Math.pow(10, orrDecimals)).toFixed(2)} ORR\n` +
      `Có thể claim: ${new BigNumber(claimableAmount).div(Math.pow(10, orrDecimals)).toFixed(2)} ORR`;
    document.getElementById("totalPurchased").innerText = new BigNumber(totalPurchased).div(Math.pow(10, orrDecimals)).toFixed(2) + " ORR";
    document.getElementById("claimed").innerText = new BigNumber(claimed).div(Math.pow(10, orrDecimals)).toFixed(2) + " ORR";
    document.getElementById("claimable").innerText = new BigNumber(claimableAmount).div(Math.pow(10, orrDecimals)).toFixed(2) + " ORR";
  } catch (err) {
    console.error("Purchase info error:", err);
    showError("Lỗi khi lấy thông tin mua: " + err.message);
  }
}

window.addEventListener('load', () => {
  initWeb3().then(() => updatePresaleInfo(true));
});
</script>
</body>
</html>